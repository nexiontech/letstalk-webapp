name: Bundle Size Monitoring

on:
  push:
    branches: ['**']  # All branches
  pull_request:
    branches: ['**']  # All PRs

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  bundle-size-check:
    name: Bundle Size Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build current branch
        run: |
          npm run build
          echo "Current build completed"

      - name: Install bc calculator
        run: sudo apt-get update && sudo apt-get install -y bc

      - name: Analyze current bundle size
        id: current-size
        run: |
          # Get current bundle sizes
          DIST_SIZE=$(du -sb dist/ | cut -f1)
          DIST_SIZE_MB=$(echo "scale=2; $DIST_SIZE / 1024 / 1024" | bc)

          # Get individual file sizes
          echo "## 📦 Bundle Size Analysis" > bundle-analysis.md
          echo "" >> bundle-analysis.md
          echo "### 📊 Current Bundle Metrics" >> bundle-analysis.md
          echo "- **Total Bundle Size**: ${DIST_SIZE_MB} MB (${DIST_SIZE} bytes)" >> bundle-analysis.md
          echo "- **Build Date**: $(date)" >> bundle-analysis.md
          echo "- **Commit**: ${{ github.sha }}" >> bundle-analysis.md
          echo "" >> bundle-analysis.md

          echo "### 📁 File Breakdown" >> bundle-analysis.md
          echo "\`\`\`" >> bundle-analysis.md
          find dist/ -type f -name "*.js" -o -name "*.css" -o -name "*.html" | xargs ls -lh | sort -k5 -hr >> bundle-analysis.md
          echo "\`\`\`" >> bundle-analysis.md

          # Store sizes for comparison
          echo "current_size=$DIST_SIZE" >> $GITHUB_OUTPUT
          echo "current_size_mb=$DIST_SIZE_MB" >> $GITHUB_OUTPUT

          # Get largest files
          echo "" >> bundle-analysis.md
          echo "### 🔍 Largest Assets" >> bundle-analysis.md
          find dist/ -type f -exec du -b {} + | sort -nr | head -10 | while read size file; do
            size_kb=$(echo "scale=2; $size / 1024" | bc)
            echo "- \`$(basename "$file")\`: ${size_kb} KB" >> bundle-analysis.md
          done

      - name: Compare with base branch (PR only)
        if: github.event_name == 'pull_request'
        id: size-comparison
        run: |
          # Checkout base branch and build
          git checkout ${{ github.event.pull_request.base.sha }}
          npm ci
          npm run build

          # Get base bundle size
          BASE_SIZE=$(du -sb dist/ | cut -f1)
          BASE_SIZE_MB=$(echo "scale=2; $BASE_SIZE / 1024 / 1024" | bc)

          # Calculate difference
          CURRENT_SIZE=${{ steps.current-size.outputs.current_size }}
          SIZE_DIFF=$((CURRENT_SIZE - BASE_SIZE))
          SIZE_DIFF_MB=$(echo "scale=2; $SIZE_DIFF / 1024 / 1024" | bc)
          SIZE_DIFF_PERCENT=$(echo "scale=2; $SIZE_DIFF * 100 / $BASE_SIZE" | bc)

          echo "" >> bundle-analysis.md
          echo "### 📈 Size Comparison (vs base branch)" >> bundle-analysis.md
          echo "- **Base Size**: ${BASE_SIZE_MB} MB" >> bundle-analysis.md
          echo "- **Current Size**: ${{ steps.current-size.outputs.current_size_mb }} MB" >> bundle-analysis.md
          echo "- **Difference**: ${SIZE_DIFF_MB} MB (${SIZE_DIFF_PERCENT}%)" >> bundle-analysis.md
          echo "" >> bundle-analysis.md

          # Determine status
          if [ "$SIZE_DIFF" -gt 0 ]; then
            if [ "${SIZE_DIFF_PERCENT%.*}" -gt 10 ]; then
              echo "### 🚨 Bundle Size Alert" >> bundle-analysis.md
              echo "Bundle size increased by more than 10%! Please review:" >> bundle-analysis.md
              echo "- Are new dependencies necessary?" >> bundle-analysis.md
              echo "- Can any dependencies be optimized or removed?" >> bundle-analysis.md
              echo "- Consider code splitting for large features" >> bundle-analysis.md
              echo "size_status=alert" >> $GITHUB_OUTPUT
            elif [ "${SIZE_DIFF_PERCENT%.*}" -gt 5 ]; then
              echo "### ⚠️ Bundle Size Warning" >> bundle-analysis.md
              echo "Bundle size increased by more than 5%. Consider optimization." >> bundle-analysis.md
              echo "size_status=warning" >> $GITHUB_OUTPUT
            else
              echo "### ✅ Bundle Size OK" >> bundle-analysis.md
              echo "Bundle size increase is within acceptable range." >> bundle-analysis.md
              echo "size_status=ok" >> $GITHUB_OUTPUT
            fi
          else
            echo "### ✅ Bundle Size Improved" >> bundle-analysis.md
            echo "Great! Bundle size decreased or stayed the same." >> bundle-analysis.md
            echo "size_status=improved" >> $GITHUB_OUTPUT
          fi

          echo "size_diff=$SIZE_DIFF" >> $GITHUB_OUTPUT
          echo "size_diff_percent=$SIZE_DIFF_PERCENT" >> $GITHUB_OUTPUT

      - name: Install size-limit for detailed analysis
        run: npm install --no-save size-limit @size-limit/preset-big-lib

      - name: Create size-limit config
        run: |
          cat > .size-limit.json << 'EOF'
          [
            {
              "name": "Main Bundle",
              "path": "dist/**/*.js",
              "limit": "500 KB"
            },
            {
              "name": "CSS Bundle",
              "path": "dist/**/*.css",
              "limit": "100 KB"
            },
            {
              "name": "Total Bundle",
              "path": "dist/**/*",
              "limit": "1 MB"
            }
          ]
          EOF

      - name: Run size-limit analysis
        run: |
          echo "" >> bundle-analysis.md
          echo "### 📏 Size Limit Analysis" >> bundle-analysis.md
          echo "\`\`\`" >> bundle-analysis.md
          npx size-limit >> bundle-analysis.md 2>&1 || echo "Size limit check completed with warnings" >> bundle-analysis.md
          echo "\`\`\`" >> bundle-analysis.md

      - name: Generate bundle composition analysis
        run: |
          echo "" >> bundle-analysis.md
          echo "### 🧩 Bundle Composition" >> bundle-analysis.md
          echo "" >> bundle-analysis.md

          # Analyze JavaScript files
          JS_SIZE=$(find dist/ -name "*.js" -exec du -cb {} + | tail -1 | cut -f1)
          CSS_SIZE=$(find dist/ -name "*.css" -exec du -cb {} + | tail -1 | cut -f1)
          HTML_SIZE=$(find dist/ -name "*.html" -exec du -cb {} + | tail -1 | cut -f1)
          ASSET_SIZE=$(find dist/ -type f ! -name "*.js" ! -name "*.css" ! -name "*.html" -exec du -cb {} + | tail -1 | cut -f1)

          JS_SIZE_KB=$(echo "scale=2; $JS_SIZE / 1024" | bc)
          CSS_SIZE_KB=$(echo "scale=2; $CSS_SIZE / 1024" | bc)
          HTML_SIZE_KB=$(echo "scale=2; $HTML_SIZE / 1024" | bc)
          ASSET_SIZE_KB=$(echo "scale=2; $ASSET_SIZE / 1024" | bc)

          echo "#### File Type Breakdown:" >> bundle-analysis.md
          echo "- **JavaScript**: ${JS_SIZE_KB} KB" >> bundle-analysis.md
          echo "- **CSS**: ${CSS_SIZE_KB} KB" >> bundle-analysis.md
          echo "- **HTML**: ${HTML_SIZE_KB} KB" >> bundle-analysis.md
          echo "- **Assets**: ${ASSET_SIZE_KB} KB" >> bundle-analysis.md

      - name: Upload bundle analysis
        uses: actions/upload-artifact@v4
        with:
          name: bundle-analysis-${{ github.run_number }}
          path: |
            bundle-analysis.md
            dist/
          retention-days: 30

      - name: Comment bundle analysis on PR
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const analysis = fs.readFileSync('bundle-analysis.md', 'utf8');

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `${analysis}\n\n---\n*Bundle size analysis completed automatically*`
            });

      - name: Create bundle size tracking issue
        if: github.event_name == 'pull_request' && steps.size-comparison.outputs.size_status == 'alert'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const analysis = fs.readFileSync('bundle-analysis.md', 'utf8');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '📦 Bundle Size Alert: Significant Increase Detected',
              body: `${analysis}

              ---
              **Automated Issue**: This issue was created because the bundle size increased by more than 10%.
              **PR**: #${{ github.event.pull_request.number }}
              **Size Increase**: ${{ steps.size-comparison.outputs.size_diff_percent }}%

              **Recommended Actions**:
              1. Review the changes in PR #${{ github.event.pull_request.number }}
              2. Identify which dependencies or code changes caused the increase
              3. Consider code splitting or lazy loading for large features
              4. Evaluate if new dependencies are essential
              5. Optimize or remove unnecessary code/dependencies

              **Bundle Size Limits**:
              - JavaScript: < 500 KB
              - CSS: < 100 KB
              - Total: < 1 MB`,
              labels: ['performance', 'bundle-size', 'automated']
            });

  webpack-bundle-analyzer:
    name: Webpack Bundle Analyzer
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install webpack-bundle-analyzer
        run: npm install --no-save webpack-bundle-analyzer

      - name: Build with bundle analysis
        run: |
          # Build the project
          npm run build

          # Generate bundle analysis
          npx webpack-bundle-analyzer dist/assets/*.js --mode static --report bundle-report.html --no-open || echo "Bundle analyzer completed"

      - name: Upload bundle analyzer report
        uses: actions/upload-artifact@v4
        with:
          name: webpack-bundle-analysis-${{ github.run_number }}
          path: |
            bundle-report.html
          retention-days: 30
        continue-on-error: true
